<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Feed Test - Smart Parking</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
        }
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .camera-box {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .camera-title {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }
        .camera-img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #0f1626;
            min-height: 300px;
            object-fit: contain;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background: #1e4620;
            color: #4ade80;
        }
        .status.error {
            background: #4a1e1e;
            color: #f87171;
        }
        .status.loading {
            background: #1e3a4a;
            color: #60a5fa;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: #00b8e6;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }
        .info {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info code {
            background: #0f1626;
            padding: 2px 8px;
            border-radius: 4px;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìπ Camera Feed Test - 192.168.0.109</h1>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Test Information:</strong><br>
            Camera IP: <code>192.168.0.109</code><br>
            API Base: <code>http://localhost:8000/api/toll-v1</code><br>
            Status: <span id="connection-status">Testing...</span><br>
            <br>
            <strong>‚ö†Ô∏è Important:</strong> FFmpeg is not installed. RTSP streaming won't work.<br>
            <strong>üí° Recommendation:</strong> Use Safari and access camera directly at <a href="http://192.168.0.109" target="_blank" style="color: #00d4ff;">http://192.168.0.109</a>
        </div>

        <div class="camera-grid">
            <!-- Snapshot Method -->
            <div class="camera-box">
                <div class="camera-title">üì∏ Snapshot Method (Recommended)</div>
                <img id="snapshot-img" class="camera-img" alt="Camera Snapshot">
                <div id="snapshot-status" class="status loading">Initializing...</div>
                <div class="controls">
                    <button onclick="startSnapshot()">‚ñ∂Ô∏è Start</button>
                    <button onclick="stopSnapshot()">‚è∏Ô∏è Stop</button>
                    <button onclick="refreshSnapshot()">üîÑ Refresh Once</button>
                </div>
            </div>

            <!-- MJPEG Stream Method -->
            <div class="camera-box">
                <div class="camera-title">üé• MJPEG Stream</div>
                <img id="mjpeg-img" class="camera-img" alt="MJPEG Stream">
                <div id="mjpeg-status" class="status loading">Ready to start</div>
                <div class="controls">
                    <button onclick="startMJPEG()">‚ñ∂Ô∏è Start Stream</button>
                    <button onclick="stopMJPEG()">‚èπÔ∏è Stop Stream</button>
                </div>
            </div>

            <!-- Direct Camera Access -->
            <div class="camera-box">
                <div class="camera-title">üåê Direct Camera (Safari Only)</div>
                <iframe id="camera-iframe" style="width: 100%; height: 400px; border: none; border-radius: 8px; background: #0f1626;"></iframe>
                <div id="iframe-status" class="status loading">Not loaded</div>
                <div class="controls">
                    <button onclick="loadCameraDirect()">üîó Load Camera Interface</button>
                    <button onclick="openInNewTab()">üîó Open in New Tab</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/toll-v1';
        const CAMERA_IP = '192.168.0.109';
        let snapshotInterval = null;

        // Test connection on load
        window.addEventListener('load', () => {
            testConnection();
            // Auto-start snapshot
            setTimeout(() => startSnapshot(), 1000);
        });

        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/camera/test-connection`);
                const data = await response.json();
                document.getElementById('connection-status').innerHTML = 
                    response.ok ? '‚úÖ Connected' : '‚ùå Connection Failed';
            } catch (error) {
                document.getElementById('connection-status').innerHTML = '‚ùå API Error';
            }
        }

        // Snapshot Method
        function startSnapshot() {
            if (snapshotInterval) clearInterval(snapshotInterval);
            
            const img = document.getElementById('snapshot-img');
            const status = document.getElementById('snapshot-status');
            
            status.className = 'status loading';
            status.textContent = 'Starting live feed...';
            
            // Function to refresh image
            const refreshImage = () => {
                const timestamp = new Date().getTime();
                img.src = `${API_BASE}/stream/snapshot?t=${timestamp}`;
            };
            
            // Refresh immediately
            refreshImage();
            
            // Set up interval (1 second = ~1 FPS)
            snapshotInterval = setInterval(refreshImage, 1000);
            
            // Update status on image load
            img.onload = () => {
                status.className = 'status success';
                status.textContent = '‚úÖ Live feed active (~1 FPS)';
            };
            
            img.onerror = () => {
                status.className = 'status error';
                status.textContent = '‚ùå Failed to load image';
            };
        }

        function stopSnapshot() {
            if (snapshotInterval) {
                clearInterval(snapshotInterval);
                snapshotInterval = null;
                document.getElementById('snapshot-status').className = 'status';
                document.getElementById('snapshot-status').textContent = '‚è∏Ô∏è Feed paused';
            }
        }

        function refreshSnapshot() {
            const img = document.getElementById('snapshot-img');
            const timestamp = new Date().getTime();
            img.src = `${API_BASE}/stream/snapshot?t=${timestamp}`;
        }

        // MJPEG Stream Method
        function startMJPEG() {
            const img = document.getElementById('mjpeg-img');
            const status = document.getElementById('mjpeg-status');
            
            status.className = 'status loading';
            status.textContent = 'Connecting to stream...';
            
            // Add timestamp to prevent caching
            img.src = `${API_BASE}/stream/mjpeg/camera1?t=${new Date().getTime()}`;
            
            img.onload = () => {
                status.className = 'status success';
                status.textContent = '‚úÖ Stream active';
            };
            
            img.onerror = () => {
                status.className = 'status error';
                status.textContent = '‚ùå Stream failed - RTSP may be unavailable';
            };
        }

        function stopMJPEG() {
            const img = document.getElementById('mjpeg-img');
            img.src = '';
            document.getElementById('mjpeg-status').className = 'status';
            document.getElementById('mjpeg-status').textContent = '‚èπÔ∏è Stream stopped';
        }

        // Direct Camera Access
        function loadCameraDirect() {
            const iframe = document.getElementById('camera-iframe');
            const status = document.getElementById('iframe-status');
            
            status.className = 'status loading';
            status.textContent = 'Loading camera interface...';
            
            iframe.src = `http://${CAMERA_IP}`;
            
            iframe.onload = () => {
                status.className = 'status success';
                status.textContent = '‚úÖ Camera interface loaded (enter credentials if prompted)';
            };
            
            iframe.onerror = () => {
                status.className = 'status error';
                status.textContent = '‚ùå Failed to load - blocked by CORS or camera offline';
            };
        }

        function openInNewTab() {
            window.open(`http://${CAMERA_IP}`, '_blank');
        }
    </script>
</body>
</html>
